Imports System
Imports System.Collections.Generic
Imports System.ComponentModel
Imports System.Data
Imports System.Drawing
Imports System.Linq
Imports System.Text
Imports System.Threading.Tasks
Imports System.Windows.Forms
Imports System.Net.Http

Imports Newtonsoft.Json

Public Class Form1

    Private Async Sub EnviarTiquetes()

        'Toma los tiquetes de la vista vw_FE_Control que toma los tiquetes de la base 
        'LDCOM_MUNDOMAGICO. Modifica la tabla GB_Control_FE pone campo estado = 1 para 
        'poner que este está en proceso de transmisión.
        'La vista vw_FE_Control y la tabla GB_Control_FE son uno a uno, por cada registro
        'en la vista hay un registro en la tabla.
        'Fecha       :    20 de Noviembre del 2018.
        'Autor       :    Jorge López Jiménez.
        'Tipo Doc    :    Primera Documentación.
        'Ubicación   :    Form1.vb.
        'Tipo Objeto :    Procedimiento Enviar tiquetes, se llama cuando carga la forma 
        '            :    y en el timer1 cada 60 segundos para transmitir los tiquetes
        '            :    por primera vez.  
        'Nombre      :    Form1.vb.
        'Base        :    LDCOM_MUNDOMAGICO.
        'Tablas      :    vw_FE_Control, GB_Control_FE

        Using client = New HttpClient()

            Dim claveValor As String = ""

            Try
                'Empieza a crear el header con la dirección local
                client.BaseAddress = New Uri("http://localhost:8080/easy-atv/api/")
                client.DefaultRequestHeaders.Add("X-KeyLicense", "KPsAaW8n3txLJsGL")
                client.DefaultRequestHeaders.Add("X-Disable-Cache", "true")
                client.DefaultRequestHeaders.Add("X-Validate-Xml", "false")

                Dim header As String
                header = "<?xml version=""1.0"" encoding=""utf-8""?>" & vbCr
                header += "<TiqueteElectronico xmlns:ds=""http://www.w3.org/2000/09/xmldsig#""" & vbCr
                header += "xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance""" & vbCr
                header += "xmlns=""https://tribunet.hacienda.go.cr/docs/esquemas/2017/v4.2/tiqueteElectronico""" & vbCr
                header += "xsi:schemaLocation=""https://tribunet.hacienda.go.cr/docs/esquemas/2017/v4.2/tiqueteElectronico https://tribunet.hacienda.go.cr/docs/esquemas/2017/v4.2/tiqueteElectronico.xsd"">" & vbCr

                'Selecciona todos los tiquetes que va a transmitir por primera vez.
                strSQL = "SELECT Consecutivo_FE, Clave_Unica_FE, Fecha_Factura, ATV_Usuario, ATV_Password, Certificado, Certificado_Password FROM vw_FE_Control WHERE TipoDoc_Id = 1 and estado = 0 and status_code is null and Clave_Unica_FE is not null ORDER BY Consecutivo_FE"
                Dim dsXML As DataSet = funFillDataSet(strSQL)
                Dim cantidadTiquetes As Integer
                cantidadTiquetes = dsXML.Tables("Tabla").Rows.Count

                'Si no hay tiquetes para transmitir se sale del procedimiento
                If (cantidadTiquetes = 0) Then
                    Exit Sub
                End If

                'Modifica la tabla GB_Control_FE con estado = 1, con esto lo marcamos para transmisión
                strSQL = "UPDATE GB_Control_FE set Estado = 1 WHERE TipoDoc_Id = 1 and estado = 0 and status_code is null and Clave_Unica_FE is not null"
                funRunSQL(strSQL)

                Dim atvUsername As String
                Dim atvPassword As String
                Dim certificateLocation As String
                Dim certificatePassword As String

                For index As Integer = 0 To cantidadTiquetes - 1

                    wait(1)
                    atvUsername = dsXML.Tables("Tabla").Rows(index)("ATV_Usuario")
                    atvPassword = dsXML.Tables("Tabla").Rows(index)("ATV_Password")
                    certificateLocation = dsXML.Tables("Tabla").Rows(index)("Certificado")
                    certificatePassword = dsXML.Tables("Tabla").Rows(index)("Certificado_Password")
                    claveValor = dsXML.Tables("Tabla").Rows(index)("Clave_Unica_FE")

                    'Toma de la vista vw_FE_Tiquetes el valor de la clave que encontro en la vista vw_FE_Control
                    'Aquí se encuentra el detalle de los artículos, varios registros por factura
                    'La vista vw_FE_Control tiene el encabezado de la factura y vw_FE_Tiquetes el detalle
                    strSQL = "SELECT * FROM vw_FE_Tiquetes WHERE Clave_Unica_FE = '" & claveValor & "'"
                    Dim dsDetalle As DataSet = funFillDataSet(strSQL)

                    If (dsDetalle.Tables("Tabla").Rows.Count = 0) Then
                        'No encontro la clave para este registro
                    Else
                        'Encuentra la clave en la vista vw_FE_Tiquetes
                        Dim consecutivoValor As String = dsXML.Tables("Tabla").Rows(index)("Consecutivo_FE")
                        Dim fechaEmisionValor As String
                        Dim fPathTMP = "D:\EasyATV\XML_Te\" & claveValor & "TMP" & ".xml"
                        Dim afileTMP As New IO.StreamWriter(fPathTMP, False)
                        'Escribe en el archivo las variables atvUsername, atvPassword ......
                        afileTMP.WriteLine(dsXML.GetXml())
                        afileTMP.Close()
                        Dim xmlTMP As Xml.XmlDocument = New Xml.XmlDocument()
                        xmlTMP.Load(fPathTMP)
                        'Toma la fecha de la factura del XML que acaba de esribir en D:\EasyATV\XML_Te\
                        fechaEmisionValor = xmlTMP.GetElementsByTagName("Fecha_Factura").Item(index).InnerText
                        'Toma otros valores de vw_FE_Tiquetes
                        Dim emisorNombreValor As String = dsDetalle.Tables("Tabla").Rows(0)("Nombre")
                        Dim emisorNombreComercialValor As String = dsDetalle.Tables("Tabla").Rows(0)("NombreComercial")
                        Dim condicionVentaValor As String = dsDetalle.Tables("Tabla").Rows(0)("CondicionVenta")
                        Dim medioPagoValor As String = dsDetalle.Tables("Tabla").Rows(0)("MedioPago")
                        Dim emisorCorreoElectronicoValor As String = dsDetalle.Tables("Tabla").Rows(0)("CorreoElectronico")
                        Dim tipo As String = dsDetalle.Tables("Tabla").Rows(0)("Tipo")
                        Dim numero As String = dsDetalle.Tables("Tabla").Rows(0)("Numero")
                        Dim provincia As String = dsDetalle.Tables("Tabla").Rows(0)("Provincia")
                        Dim canton As String = dsDetalle.Tables("Tabla").Rows(0)("Canton")
                        Dim distrito As String = dsDetalle.Tables("Tabla").Rows(0)("Distrito")
                        Dim barrio As String = dsDetalle.Tables("Tabla").Rows(0)("Barrio")
                        Dim otrasSenas As String = dsDetalle.Tables("Tabla").Rows(0)("OtrasSenas")
                        Dim codigoPais As String = dsDetalle.Tables("Tabla").Rows(0)("CodigoPais")
                        Dim numeroTelefono As String = dsDetalle.Tables("Tabla").Rows(0)("NumTelefono")
                        Dim codigoPaisFax As String = dsDetalle.Tables("Tabla").Rows(0)("CodigoPaisFax")
                        Dim numeroTelefonoFax As String = dsDetalle.Tables("Tabla").Rows(0)("NumTelefonoFax")

                        'Empieza a escribir el XML en las variables
                        Dim clave As String = " <Clave>" & claveValor & "</Clave>" & vbCr
                        Dim consecutivo As String = "   <NumeroConsecutivo>" & consecutivoValor & "</NumeroConsecutivo>" & vbCr
                        Dim fechaEmision As String = "  <FechaEmision>" & fechaEmisionValor & "</FechaEmision>" & vbCr
                        'El emisor está formado por estos campos
                        Dim emisor As String = ""
                        emisor += "    <Emisor>" & vbCr
                        emisor += "     <Nombre>" & emisorNombreValor & "</Nombre>" & vbCr
                        emisor += "     <Identificacion>" & vbCr
                        emisor += "         <Tipo>" & tipo & "</Tipo>" & vbCr
                        emisor += "         <Numero>" & numero & "</Numero>" & vbCr
                        emisor += "     </Identificacion>" & vbCr
                        emisor += "     <NombreComercial>" & emisorNombreComercialValor & "</NombreComercial>" & vbCr
                        emisor += "     <Ubicacion>" & vbCr
                        emisor += "         <Provincia>" & provincia & "</Provincia>" & vbCr
                        emisor += "         <Canton>" & canton & "</Canton>" & vbCr
                        emisor += "         <Distrito>" & distrito & "</Distrito>" & vbCr
                        emisor += "         <Barrio>" & barrio & "</Barrio>" & vbCr
                        emisor += "         <OtrasSenas>" & otrasSenas & "</OtrasSenas>" & vbCr
                        emisor += "     </Ubicacion>" & vbCr
                        emisor += "     <Telefono>" & vbCr
                        emisor += "         <CodigoPais>" & codigoPais & "</CodigoPais>" & vbCr
                        emisor += "         <NumTelefono>" & numeroTelefono & "</NumTelefono>" & vbCr
                        emisor += "     </Telefono>" & vbCr
                        emisor += "     <Fax>" & vbCr
                        emisor += "         <CodigoPais>" & codigoPaisFax & "</CodigoPais>" & vbCr
                        emisor += "         <NumTelefono>" & numeroTelefonoFax & "</NumTelefono>" & vbCr
                        emisor += "     </Fax>" & vbCr
                        emisor += "     <CorreoElectronico>" & emisorCorreoElectronicoValor & "</CorreoElectronico>" & vbCr
                        emisor += " </Emisor>" & vbCr

                        Dim condicionVenta As String = "  <CondicionVenta>" & condicionVentaValor & "</CondicionVenta>" & vbCr
                        Dim medioPago As String = "  <MedioPago>" & medioPagoValor & "</MedioPago>" & vbCr

                        Dim detalle As String
                        detalle = " <DetalleServicio>" & vbCr
                        'Recorre la vista vw_FE_Tiquetes donde está el detalle de la factura
                        For i As Integer = 0 To dsDetalle.Tables("Tabla").Rows.Count - 1
                            Dim codigoTipo As String = dsDetalle.Tables("Tabla").Rows(i)("TipoCodigo")
                            Dim codigoCodigo As String = dsDetalle.Tables("Tabla").Rows(i)("Codigo")
                            Dim impuestoCodigo As String = dsDetalle.Tables("Tabla").Rows(i)("CodigoImpuesto")
                            Dim impuestoTarifa As String = dsDetalle.Tables("Tabla").Rows(i)("TarifaImpuesto")
                            Dim cantidad As Double = dsDetalle.Tables("Tabla").Rows(i)("Cantidad")
                            Dim unidadMedida As String = dsDetalle.Tables("Tabla").Rows(i)("UnidadMedida")
                            Dim detalleValor As String = dsDetalle.Tables("Tabla").Rows(i)("Detalle")
                            Dim precioUnitario As Double = dsDetalle.Tables("Tabla").Rows(i)("PrecioUnitario")
                            Dim montoTotal As Double = dsDetalle.Tables("Tabla").Rows(i)("MontoTotal")
                            Dim montoImpuesto As Double = dsDetalle.Tables("Tabla").Rows(i)("MontoImpuesto")
                            Dim montoDescuento As Double = dsDetalle.Tables("Tabla").Rows(i)("MontoDescuento")
                            Dim naturalezaDescuento As String = dsDetalle.Tables("Tabla").Rows(i)("NaturalezaDescuento")
                            Dim subTotal As Double = dsDetalle.Tables("Tabla").Rows(i)("SubTotal")
                            Dim montoTotalLinea As Double = dsDetalle.Tables("Tabla").Rows(i)("MontoTotalLinea")

                            detalle += "        <LineaDetalle>" & vbCr
                            detalle += "            <NumeroLinea>" & i + 1 & "</NumeroLinea>" & vbCr
                            detalle += "            <Codigo>" & vbCr
                            detalle += "                <Tipo>" & codigoTipo & "</Tipo>" & vbCr
                            detalle += "                <Codigo>" & codigoCodigo & "</Codigo>" & vbCr
                            detalle += "            </Codigo>" & vbCr
                            detalle += "            <Cantidad>" & cantidad & "</Cantidad>" & vbCr
                            detalle += "            <UnidadMedida>" & unidadMedida & "</UnidadMedida>" & vbCr
                            detalle += "            <Detalle>" & detalleValor.Replace("&", " ") & "</Detalle>" & vbCr
                            detalle += "            <PrecioUnitario>" & precioUnitario & "</PrecioUnitario>" & vbCr
                            detalle += "            <MontoTotal>" & montoTotal & "</MontoTotal>" & vbCr
                            detalle += "            <MontoDescuento>" & montoDescuento & "</MontoDescuento>" & vbCr
                            detalle += "            <NaturalezaDescuento>" & naturalezaDescuento & "</NaturalezaDescuento>" & vbCr
                            detalle += "            <SubTotal>" & subTotal & "</SubTotal>" & vbCr
                            detalle += "            <Impuesto>" & vbCr
                            detalle += "                <Codigo>" & impuestoCodigo & "</Codigo>" & vbCr
                            detalle += "                <Tarifa>" & impuestoTarifa & "</Tarifa>" & vbCr
                            detalle += "                <Monto>" & montoImpuesto & "</Monto>" & vbCr
                            detalle += "            </Impuesto>" & vbCr
                            detalle += "            <MontoTotalLinea>" & montoTotalLinea & "</MontoTotalLinea>" & vbCr
                            detalle += "        </LineaDetalle>" & vbCr
                        Next

                        'Escribe en detalle todos los artículos que se compraron
                        detalle += " </DetalleServicio>" & vbCr
                        'Escribe resumen de la factura
                        Dim resumen As String
                        resumen = " <ResumenFactura>" & vbCr
                        resumen += "        <CodigoMoneda>" & dsDetalle.Tables("Tabla").Rows(0)("CodigoMoneda") & "</CodigoMoneda>" & vbCr
                        resumen += "        <TipoCambio>" & dsDetalle.Tables("Tabla").Rows(0)("TipoCambio") & "</TipoCambio>" & vbCr
                        resumen += "        <TotalServGravados>" & dsDetalle.Tables("Tabla").Rows(0)("TotalServGravados") & "</TotalServGravados>" & vbCr
                        resumen += "        <TotalServExentos>" & dsDetalle.Tables("Tabla").Rows(0)("TotalServExentos") & "</TotalServExentos>" & vbCr
                        resumen += "        <TotalMercanciasGravadas>" & dsDetalle.Tables("Tabla").Rows(0)("TotalMercanciasGravadas") & "</TotalMercanciasGravadas>" & vbCr
                        resumen += "        <TotalMercanciasExentas>" & dsDetalle.Tables("Tabla").Rows(0)("TotalMercanciasExentas") & "</TotalMercanciasExentas>" & vbCr
                        resumen += "        <TotalGravado>" & dsDetalle.Tables("Tabla").Rows(0)("TotalGravado") & "</TotalGravado>" & vbCr
                        resumen += "        <TotalExento>" & dsDetalle.Tables("Tabla").Rows(0)("TotalExento") & "</TotalExento>" & vbCr
                        resumen += "        <TotalVenta>" & dsDetalle.Tables("Tabla").Rows(0)("TotalVenta") & "</TotalVenta>" & vbCr
                        resumen += "        <TotalDescuentos>" & dsDetalle.Tables("Tabla").Rows(0)("TotalDescuentos") & "</TotalDescuentos>" & vbCr
                        resumen += "        <TotalVentaNeta>" & dsDetalle.Tables("Tabla").Rows(0)("TotalVentaNeta") & "</TotalVentaNeta>" & vbCr
                        resumen += "        <TotalImpuesto>" & dsDetalle.Tables("Tabla").Rows(0)("TotalImpuesto") & "</TotalImpuesto>" & vbCr
                        resumen += "        <TotalComprobante>" & dsDetalle.Tables("Tabla").Rows(0)("TotalComprobante") & "</TotalComprobante>" & vbCr
                        resumen += "    </ResumenFactura>" & vbCr

                        'Escribe la normativa
                        Dim normativa As String
                        normativa = "   <Normativa>" & vbCr
                        normativa += "      <NumeroResolucion>" & "DGT-R-48-2016" & "</NumeroResolucion>" & vbCr
                        normativa += "      <FechaResolucion>" & "07-10-2016 08:00:00" & "</FechaResolucion>" & vbCr
                        normativa += "  </Normativa>" & vbCr

                        Dim otros As String

                        otros = "   <Otros>" & vbCr
                        otros += "       <OtroTexto></OtroTexto>" & vbCr
                        otros += "  </Otros>" & vbCr

                        Dim footer As String = "</TiqueteElectronico>"
                        Dim tiqueteXML As String

                        'Escribe el contenido del XML en la variable tiqueteXML
                        tiqueteXML = header + clave + consecutivo + fechaEmision + emisor + condicionVenta + medioPago + detalle + resumen + normativa + otros + footer
                        'Escribe en el archivo el XML
                        Dim fPath = "D:\EasyATV\XML_Te\" & claveValor & ".xml"
                        Dim afile As New IO.StreamWriter(fPath, False)
                        afile.WriteLine(tiqueteXML)
                        afile.Close()

                        Dim arrayDeBytes As Byte() = System.IO.File.ReadAllBytes(fPath)

                        'Convierte un arreglo de 8-bit de enteros a su equivalente a representación de string
                        'en base de 64 digitos.
                        'Parametros : Arreglo de 8 bits de enteros.                   
                        'Retorna:La representación en string en base a 64 bits en el arreglo.
                        Dim xmlToSignBase64 As String = Convert.ToBase64String(arrayDeBytes)

                        'Lo escribe en formato JSON con la demas informacion
                        Dim json As String = "{""atvUsername"":""" + atvUsername + """, " _
                            & """atvPassword"":""" + atvPassword + """," _
                            & """certificateLocation"":""" + certificateLocation + """, " _
                            & """certificatePassword"":""" + certificatePassword + """, " _
                            & """xmlToSign"":""" _
                            & xmlToSignBase64 _
                            & """}"

                        'Lo transmite al Ministerio de Hacienda
                        Dim response = Await client.PostAsync("atv/recepcion", New StringContent(json, Encoding.UTF8, "application/json"))
                        Dim resultContent As String = Await response.Content.ReadAsStringAsync()
                        'Modifica la tabla de GB_Control_FE, le pone en Status_Code 
                        'la respuesta = 200 Exitoso, 400 no hay conexion con Hacienda
                        'Y resultContent es el resultado de lo que envía Hacienda
                        strSQL = "UPDATE GB_Control_FE set Status_Code = " & response.StatusCode & ", Json = '" & resultContent.Replace("'", "''") & "' WHERE Clave_Unica_FE = '" & claveValor & "'"
                        funRunSQL(strSQL)

                        Dim obj As JSON_result

                        If CInt(response.StatusCode) = 200 Then 'Hay conexión con Hacienda y la respuesta es exitosa
                            Try
                                'Escribe el objeto de respuesta en la tabla GB_Control_FE con la clave correspondiente
                                obj = JsonConvert.DeserializeObject(Of JSON_result)(resultContent)
                                strSQL = "UPDATE GB_Control_FE set Estado = 1, Recepcion_Comprobante = '" & obj.estado & "' WHERE Clave_Unica_FE = '" & claveValor & "'"
                                funRunSQL(strSQL)
                            Catch ex As Exception

                            End Try
                        Else 'Asume que no hay conexión con hacienda con el error 400 o da otro código de error
                            Try
                                'Pone el estado del encabezado de Factura Elctrónica en 0 para procesarla después 
                                strSQL = "UPDATE GB_Control_FE set Estado = 0 WHERE Clave_Unica_FE = '" & claveValor & "'"
                                funRunSQL(strSQL)
                            Catch ex As Exception

                            End Try

                            'No está haciendo nada
                            Try
                            Catch ex As Exception
                            End Try

                        End If

                        'Escribe un archivo en formato JSON en este dirección
                        'en la máquina que se usa facturación D:\EasyATV\Json_Te                        
                        Dim fPathJson = "D:\EasyATV\Json_Te\" & claveValor & "_" & Date.Now.ToString.Replace(":", "")
                        Dim afileJson As New IO.StreamWriter(fPathJson.Replace("/", "").Replace(".", "") & ".json", False)
                        afileJson.WriteLine(resultContent)
                        afileJson.Close()
                    End If

                    MostrarTiquetes()

                Next

                MostrarTiquetes()

            Catch ex As Exception
                'Si algo falla en todo el procedimiento vuelve el estado de la 
                'factura electrónica a 0 para procesar después.

                strSQL = "UPDATE GB_Control_FE set Estado = 0 WHERE Clave_Unica_FE = '" & claveValor & "'"
                funRunSQL(strSQL)
            End Try

        End Using


    End Sub 'Termina procedimiento EnviarTiquetes()


    Private Sub wait(ByVal seconds As Integer)
        For i As Integer = 0 To seconds * 100
            System.Threading.Thread.Sleep(10)
            Application.DoEvents()
        Next
    End Sub







    'El timer2 que se encuentra en el mismo Form1.vb corre cada 60 minutos y toma los  
    'tíquetes que han quedado pendientes de transmitir por algún error por el proceso que se hace en el 
    'timer1 con el estado en la tabla GB_Control_FE = 0.
    'Fecha       :    21 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Timer.
    'Nombre      :    Timer2.
    'Base        :    LDCOM_MUNDOMAGICO
    'Tablas      :    vw_FE_Control, GB_Control_FE

    Private Async Sub EstadoRecepcion()

        Using client = New HttpClient()

            Try
                'Llena valores del encabezado de la trama. 
                Dim claveValor As String = ""
                client.BaseAddress = New Uri("http://localhost:8080/easy-atv/api/")
                client.DefaultRequestHeaders.Add("X-KeyLicense", "KPsAaW8n3txLJsGL")

                'Toma los registros del Encabezado de la factura, ya el tiquete se transmitió y falló.
                'Se toma que los valores Tipo Doc y estado = 1 y 
                '(Estado_Recepcion Is null Or (Estado_Recepcion != 'aceptado' AND Estado_Recepcion != 'rechazado'))
                strSQL = "SELECT Estado_Recepcion, Consecutivo_FE, Clave_Unica_FE, Fecha_Factura, ATV_Usuario, ATV_Password, Certificado, Certificado_Password FROM vw_FE_Control WHERE TipoDoc_Id = 1 and estado = 1 and Clave_Unica_FE is not null and (Estado_Recepcion is null OR (Estado_Recepcion != 'aceptado' AND Estado_Recepcion != 'rechazado')) ORDER BY Consecutivo_FE"
                Dim dsXML As DataSet = funFillDataSet(strSQL)
                Dim cantidadTiquetes As Integer
                cantidadTiquetes = dsXML.Tables("Tabla").Rows.Count

                If (cantidadTiquetes = 0) Then 'Si no hay tiquetes que ya se habían transmitido.
                    Exit Sub
                End If

                Dim atvUsername As String
                Dim atvPassword As String
                Dim certificateLocation As String
                Dim certificatePassword As String

                'Por cada Factura Encabezado que tome, toma los valores pricipales de la base de datos
                'y toma los valores de JSON y demás datos del archivo que había escrito en la primer transmisión.
                For index As Integer = 0 To cantidadTiquetes - 1

                    atvUsername = dsXML.Tables("Tabla").Rows(index)("ATV_Usuario")
                    atvPassword = dsXML.Tables("Tabla").Rows(index)("ATV_Password")
                    claveValor = dsXML.Tables("Tabla").Rows(index)("Clave_Unica_FE")

                    Dim json As String = "{""atvUsername"":""" + atvUsername + """, " _
                            & """atvPassword"":""" + atvPassword + "" _
                            & """}"

                    'Transmite a Hacienda
                    Dim response = Await client.PostAsync("atv/recepcion/" & claveValor, New StringContent(json, Encoding.UTF8, "application/json"))
                    Dim resultContent As String = Await response.Content.ReadAsStringAsync()
                    'Modifica los datos de la tabla según los datos que recibe de Hacienda
                    strSQL = "UPDATE GB_Control_FE set Status_Code_Estado_Recepcion = " & response.StatusCode & ", Json_Estado_Recepcion = '" & resultContent.Replace("'", "''") & "' WHERE Clave_Unica_FE = '" & claveValor & "'"
                    funRunSQL(strSQL)

                    Dim obj As JSON_result

                    If CInt(response.StatusCode) = 200 Then 'La respuesta es exitosa
                        Try
                            obj = JsonConvert.DeserializeObject(Of JSON_result)(resultContent)
                            strSQL = "UPDATE GB_Control_FE set Estado_Recepcion = '" & obj.estado & "' WHERE Clave_Unica_FE = '" & claveValor & "'"
                            funRunSQL(strSQL)
                        Catch ex As Exception
                        End Try

                    Else 'La respuesta no es exitosa, puede ser 400 u otro valor.

                        'Hay dos try catch que no hacen nada
                        Try
                        Catch ex As Exception
                        End Try

                        Try
                        Catch ex As Exception
                        End Try

                    End If

                    'Escribe en Json_Estado_Recepcion_Te el archivo
                    Dim fPathJson = "D:\EasyATV\Json_Estado_Recepcion_Te\" & claveValor & "_" & Date.Now.ToString.Replace(":", "")
                    Dim afileJson As New IO.StreamWriter(fPathJson.Replace("/", "").Replace(".", "") & ".json", False)
                    afileJson.WriteLine(resultContent)
                    afileJson.Close()
                Next

                'Muestra los tiquetes
                MostrarTiquetes()
            Catch ex As Exception

            End Try

        End Using
    End Sub


    'El procedimiento de carga de Form1 Muestra datos de tiquetes que se transmiten por primera
    'vez y los pendientes en el Datagrid 1 y 2 y después hace un primer intento de enviar tíquetes
    'antes de que corra el timer1 que corre al minuto de iniciado el programa.
    'Antes de hacer esto pone los DataGrid en modo de lectura para que el usuario no puede leer  
    'ni eliminar datos directamente en los DataGrid.
    'Fecha       :    19 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Procedimiento Carga de Form1.
    'Nombre      :    Form1.vb.
    'Base        :    LDCOM_MUNDOMAGICO.
    'Tablas      :    Ninguna

    Private Sub Form1_Load(sender As Object, e As EventArgs) Handles MyBase.Load

        Me.DataGridView1.ReadOnly = True                'Pone el DataGrid solo de lectura para que no se modifiquen datos
        Me.DataGridView1.AllowUserToAddRows = False     'Deshabilita Agregar datos al DataGrid
        Me.DataGridView1.AllowUserToDeleteRows = False  'Deshabilita eliminar datos del DataGrid
        Me.DataGridView2.ReadOnly = True                'Pone el DataGrid2 solo de lectura para que no se modifiquen datos
        Me.DataGridView2.AllowUserToAddRows = False     'Deshabilita Agregar datos al DataGrid2
        Me.DataGridView2.AllowUserToDeleteRows = False  'Deshabilita Eliminar datos al DataGrid2
        Me.SetBounds(1, 1, 1300, 600)                   'Pone la forma Form1.vbp en una forma centrada en la pantalla
        MostrarTiquetes()                               'Muestra los tiquetes a enviar en el DataGrid1
        MostrarTiquetesEnviado()                        'Muestra los tiquetes que están pendientes en el DataGrid2 
        EnviarTiquetes()                                'Envía tíquetes que está leyendo y no estaban pendientes a Hacienda

    End Sub


    'Este procedimiento toma los tiquetes pendientes por primera vez. 
    'Muestra los tiquetes en el DataGrid1.
    'Los datos los toma de la vista vw_FE_Control que toma los datos de una tabla de Producción de la base de
    'datos LDCOM_MUNDOMAGICO que es la base de datos de LDCOM.
    'Las condiciones que busca en la tabla es : 
    'TipoDoc_Id = 1, estado = 0,status_code Is null,Clave_Unica_FE Is Not null.
    'Fecha       :    19 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Timer1.
    'Nombre      :    Form1.vb.
    'Base        :    LDCOM_MUNDOMAGICO.
    'Tablas      :    vw_FE_Control.  

    Private Sub MostrarTiquetes()
        Dim ds As DataSet
        strSQL = "SELECT Consecutivo_FE, Clave_Unica_FE, Fecha_Factura, Recepcion_Comprobante, Estado_Recepcion FROM vw_FE_Control WHERE TipoDoc_Id = 1 and estado = 0 and status_code is null and Clave_Unica_FE is not null ORDER BY Consecutivo_FE"
        ds = funFillDataSet(strSQL)
        Me.DataGridView1.DataSource = ds.Tables("Tabla")
    End Sub


    'Este procedimiento toma los tiquetes que fallaron en su transmisión al Ministerio. 
    'Muestra los tiquetes en el DataGrid1.
    'Los datos los toma de la vista vw_FE_Control que toma los datos de una tabla de Producción de la base de
    'datos LDCOM_MUNDOMAGICO que es la base de datos de LDCOM.
    'Las condiciones que busca en la tabla es : 
    'TipoDoc_Id = 1, estado = 1,status_code Is null,CAST(Fecha_Factura AS DATE) = CAST(GETDATE().
    'La diferencia con los tiquetes nuevos es que pide el status_code = 1 y la fecha igual a la fecha de hoy.
    'Fecha       :    19 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Timer1.
    'Nombre      :    Form1.vb.
    'Base        :    LDCOM_MUNDOMAGICO.
    'Tablas      :    vw_FE_Control.    

    Private Sub MostrarTiquetesEnviado()
        Dim ds As DataSet
        strSQL = "SELECT Consecutivo_FE, Clave_Unica_FE, Fecha_Factura, Recepcion_Comprobante, Estado_Recepcion FROM vw_FE_Control WHERE TipoDoc_Id = 1 and estado = 1 AND CAST(Fecha_Factura AS DATE) = CAST(GETDATE() AS DATE) ORDER BY Consecutivo_FE"
        ds = funFillDataSet(strSQL)
        Me.DataGridView2.DataSource = ds.Tables("Tabla")
    End Sub


    'Revisa los tiquetes que ya se han transmitido pero que
    'han sido rechazados, toma de los archivos las causas de rechazo 
    'y actualiza la base de datos, sobre todo la tabla GB_Control_FE que lleva 
    'el encabezado de los tiquetes.
    'Fecha         :    24 de Noviembre del 2018.
    'Autor         :    Jorge López Jiménez.
    'Tipo Doc      :    Primera Documentación.
    'Ubicación     :    Form1.vb.
    'Tipo Objeto   :    Procedimiento a nivel de forma.     
    'Procedimiento :    Privado Sub. 
    'Nombre        :    TiquetesRechazados
    'Base          :    LDCOM_MUNDOMAGICO.
    'Tablas        :    GB_Control_FE.

    Private Sub TiquetesRechazados()

        Dim obj As JSON_result

        strSQL = "SELECT Json_Estado_Recepcion, Clave_Unica_FE FROM GB_Control_FE WHERE TipoDoc_Id = 1 and Estado_Recepcion = 'rechazado' AND Json_Estado_Recepcion like '%rechazado%'"
        Dim ds As DataSet = funFillDataSet(strSQL)

        For i As Integer = 0 To ds.Tables("Tabla").Rows.Count - 1
            obj = JsonConvert.DeserializeObject(Of JSON_result)(ds.Tables("Tabla").Rows(i)("Json_Estado_Recepcion"))

            Dim base64 = obj.resultXml
            'Dim base64 = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48TWVuc2FqZUhhY2llbmRhIHhtbG5zPSJodHRwczovL3RyaWJ1bmV0LmhhY2llbmRhLmdvLmNyL2RvY3MvZXNxdWVtYXMvMjAxNy92NC4yL21lbnNhamVIYWNpZW5kYSI+CiAgICA8Q2xhdmU+NTA2MDIwOTE4MDAzMTAxNTU1OTcyMTAyMDAwMDIwNDAwMDAwNzU5MzYxOTk5OTk5OTk8L0NsYXZlPgogICAgPE5vbWJyZUVtaXNvcj5CQU5HS09LIElOVkVTVE1FTlRTIEpWLFMuQQo8L05vbWJyZUVtaXNvcj4KICAgIDxUaXBvSWRlbnRpZmljYWNpb25FbWlzb3I+MDI8L1RpcG9JZGVudGlmaWNhY2lvbkVtaXNvcj4KICAgIDxOdW1lcm9DZWR1bGFFbWlzb3I+MzEwMTU1NTk3MjwvTnVtZXJvQ2VkdWxhRW1pc29yPgogICAgPE5vbWJyZVJlY2VwdG9yLz4KICAgIDxUaXBvSWRlbnRpZmljYWNpb25SZWNlcHRvci8+CiAgICA8TnVtZXJvQ2VkdWxhUmVjZXB0b3IvPgogICAgPE1lbnNhamU+MzwvTWVuc2FqZT4KICAgIDxEZXRhbGxlTWVuc2FqZT5FbCBjb21wcm9iYW50ZSBlbGVjdHLDs25pY28gdGllbmUgbG9zIHNpZ3VpZW50ZXMgZXJyb3JlczogCgpbCmNvZGlnbywgbWVuc2FqZSwgZmlsYSwgY29sdW1uYQotNDUsICJFbCBtb250byBkZWwgaW1wdWVzdG8gZGUgbGEgbMOtbmVhICgxKSBubyBjb3JyZXNwb25kZSBhbCB2YWxvciBkZSBtdWx0aXBsaWNhciBlbCBzdWJ0b3RhbCBwb3IgbGEgdGFyaWZhIGRlbCBpbXB1ZXN0by4gKDY1LjAwMDAwKSIsIDAsIDAKCl08L0RldGFsbGVNZW5zYWplPgogICAgPE1vbnRvVG90YWxJbXB1ZXN0bz4wLjAwMDA8L01vbnRvVG90YWxJbXB1ZXN0bz4KICAgIDxUb3RhbEZhY3R1cmE+NTAwLjAwMDA8L1RvdGFsRmFjdHVyYT4KPGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIgSWQ9ImlkLWFkYmIwMDQ0ZjU2OGYwN2VkZDM0OTI5NTI4ZDY2ODNjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzOlJlZmVyZW5jZSBJZD0ici1pZC0xIiBUeXBlPSIiIFVSST0iIj48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvVFIvMTk5OS9SRUMteHBhdGgtMTk5OTExMTYiPjxkczpYUGF0aD5ub3QoYW5jZXN0b3Itb3Itc2VsZjo6ZHM6U2lnbmF0dXJlKTwvZHM6WFBhdGg+PC9kczpUcmFuc2Zvcm0+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPjBTejhRZXIrMzd1QTRwQ3pFV2pxeTZ6Yk9GOGxIaE1EZmlmZk9JeTdXVk09PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48ZHM6UmVmZXJlbmNlIFR5cGU9Imh0dHA6Ly91cmkuZXRzaS5vcmcvMDE5MDMjU2lnbmVkUHJvcGVydGllcyIgVVJJPSIjeGFkZXMtaWQtYWRiYjAwNDRmNTY4ZjA3ZWRkMzQ5Mjk1MjhkNjY4M2MiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM+PGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT5XS3o2RmtBK25QTVlQV2NvZmpQNVRKczhTWk85bWI5YzVVMStydVJTUVhJPTwvZHM6RGlnZXN0VmFsdWU+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZSBJZD0idmFsdWUtaWQtYWRiYjAwNDRmNTY4ZjA3ZWRkMzQ5Mjk1MjhkNjY4M2MiPlIwTXJwVXUySDVCdXFzNFJFeFllYWVzN2dTL05ncUhyK0YyTWlBbW44clhoeDVzZWZQS3JEUjBadGxVUE1RVmE1amV2Qm11ZFg0L01jYmVUcXBxT3pkeS8yNjltaSttWjQrWWprRm9QajFYWEdkUHF6WEMzTXVaVFFuYkNqaEpMUXg0RXZBTHk2RWVHYU5aYnVMQ0dCWTVuK0tvK1FGVWgvM01qT09vZkZOcDVRZzhrdEpIL09WeWtzaDRGbVlwdUowcHhVNktkMWZWNVpsSEMxcnowcjVhYXNMczErbit2ellQbExqdTZBNHBtbFlHNTNQazluVjN2QlpwVWRidlFhSHNMTlI4UlZKNXRxS0J4ejJLQUI5aUxLdUMwYlVLeVFtTW15Ti9Tbkl1cHRRa0kwMndYcVUzUS9MNXhkUUE1RWF4aHY1K2hmR1grN2U1TUY5dGtOdz09PC9kczpTaWduYXR1cmVWYWx1ZT48ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlGZ1RDQ0JHbWdBd0lCQWdJVFNBQUFBSURoWXF5ZnZoQjVIUUFBQUFBQWdEQU5CZ2txaGtpRzl3MEJBUXNGQURDQm16RVpNQmNHQTFVRUJSTVFRMUJLTFRRdE1EQXdMVEF3TkRBeE56RUxNQWtHQTFVRUJoTUNRMUl4SkRBaUJnTlZCQW9URzBKQlRrTlBJRU5GVGxSU1FVd2dSRVVnUTA5VFZFRWdVa2xEUVRFaU1DQUdBMVVFQ3hNWlJFbFdTVk5KVDA0Z1UwbFRWRVZOUVZNZ1JFVWdVRUZIVHpFbk1DVUdBMVVFQXhNZVEwRWdVMGxPVUVVZ0xTQlFSVkpUVDA1QklFcFZVa2xFU1VOQklIWXlNQjRYRFRFM01ETXhOekUzTVRFeU9Gb1hEVEl4TURNeE5qRTNNVEV5T0Zvd2Z6RVpNQmNHQTFVRUJSTVFRMUJLTFRJdE1UQXdMVEEwTWpBd05URUxNQWtHQTFVRUJoTUNRMUl4R1RBWEJnTlZCQW9URUZCRlVsTlBUa0VnU2xWU1NVUkpRMEV4T2pBNEJnTlZCQU1UTVVWVFZFRkVUeTFOU1U1SlUxUkZVa2xQSUVSRklFaEJRMGxGVGtSQklDaFRSVXhNVHlCRlRFVkRWRkpQVGtsRFR5a3dnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDcUt2ZjgrU1IyUTBJMU9leG1DVHZFTDBHZWRJM2FyK3NTaldWZEMzRTdQYWQ3NFdtQzBIZlRvRTFFeklpL0IydFo3LzZWY01sUVpkbnBzei9vbnVFcUsza2JreExtMnBGeEt4ZkprQU15V1dNVnVCZXhUaU1IOEIrRFZkbVFQTTZXWWVxcC8ybzQzdXczY2FHbHRyYkFpTGZDb3FrM090blc2ZE53OUhQaEVsbEtaNktCdlBHYjlGTnJqR0phbVBFTStPM010VzViY3Q3TWpOWlF0UGNCSC96TERWVlNHY0JGRnprUVlRb3g2QXBHbmhYRElNNkxXZUo0eGRGczNKZTNFMWJ2NjN6a3p5Y1hUQTE1L2FPUllBYmtZSjBXSGIreFVNRW5LVWFJMHFBc3MxdVRwVHBBcmJsNngwZGZJQ2k3d21uemRNRDRyd0FGWjZ5NzlJWGJBZ01CQUFHamdnSFhNSUlCMHpBT0JnTlZIUThCQWY4RUJBTUNCc0F3SFFZRFZSME9CQllFRkQyUk80RUVsQjIyZW51VHdvM01ka0xwVzdDWU1COEdBMVVkSXdRWU1CYUFGSWdrL090eDBuSEpxRm15QzMrVTNFK0VXdHJTTUdBR0ExVWRId1JaTUZjd1ZhQlRvRkdHVDJoMGRIQTZMeTltWkdrdWMybHVjR1V1Wm1rdVkzSXZjbVZ3YjNOcGRHOXlhVzh2UTBFbE1qQlRTVTVRUlNVeU1DMGxNakJRUlZKVFQwNUJKVEl3U2xWU1NVUkpRMEVsTWpCMk1pNWpjbXd3Z1pjR0NDc0dBUVVGQndFQkJJR0tNSUdITUZzR0NDc0dBUVVGQnpBQ2hrOW9kSFJ3T2k4dlptUnBMbk5wYm5CbExtWnBMbU55TDNKbGNHOXphWFJ2Y21sdkwwTkJKVEl3VTBsT1VFVWxNakF0SlRJd1VFVlNVMDlPUVNVeU1FcFZVa2xFU1VOQkpUSXdkakl1WTNKME1DZ0dDQ3NHQVFVRkJ6QUJoaHhvZEhSd09pOHZiMk56Y0M1emFXNXdaUzVtYVM1amNpOXZZM053TUR3R0NTc0dBUVFCZ2pjVkJ3UXZNQzBHSlNzR0FRUUJnamNWQ0lYRTZsdUMwZU0xbFpFYmd2bVhHSWFseTJ1QmY0R1Foblhlc2x3Q0FXUUNBUWN3RXdZRFZSMGxCQXd3Q2dZSUt3WUJCUVVIQXdRd0d3WUpLd1lCQkFHQ054VUtCQTR3RERBS0JnZ3JCZ0VGQlFjREJEQVZCZ05WSFNBRURqQU1NQW9HQ0dDQlBBRUJBUUVHTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBUytIZkpPd2RobENJVlNpTXVjRTJvVTdvRy94ckgvOU1RWUlIREY4c3dzZ0d1dm9oakRHb2lyeUtQL1Ria2R2ODFLdVBHU1NZdGl1bXNEVnpUOVNLTE5MSExPR1BDMjJRT1FLazhqc1c3d2pQdkNpL0hNdittMysyOFg5RzV1MTFUSzNRZG8yZDFaL3Ryamg3aUl5UU9hQThKQkt3WTltaDA2R1o3UjdwdHEvUlZPYXZpUnNLaHIvNTEwdS83TWg3T29aVlZEc3R4QjhMMnB5djdXd2pxVmVZSUY5b25lTG5iMjVjSmRmQU5JTHRqSUJ0UlVDMXBxU1BuVktoai9zZGt1SzNSbHNPRUhSN2U0WFdKdGQ4RG5UNDhWWnk3bTNwVHZla2k4dXM3SEZnNVRsdGNnb0xxS21mZFJUNlUvMnliKzRxcFdadXowVmd1YkNVOG9XZHE8L2RzOlg1MDlDZXJ0aWZpY2F0ZT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSU5hakNDQzFLZ0F3SUJBZ0lUVGdBQUFBUGU4YUZ1RDhmdkJRQUFBQUFBQXpBTkJna3Foa2lHOXcwQkFRMEZBREJ6TVJrd0Z3WURWUVFGRXhCRFVFb3RNaTB4TURBdE1EazRNekV4TVEwd0N3WURWUVFMRXdSRVEwWkVNUTh3RFFZRFZRUUtFd1pOU1VOSlZGUXhDekFKQmdOVkJBWVRBa05TTVNrd0p3WURWUVFERXlCRFFTQlNRVWxhSUU1QlEwbFBUa0ZNSUMwZ1EwOVRWRUVnVWtsRFFTQjJNakFlRncweE5UQXlNalV5TVRFeE16ZGFGdzB6TVRBeU1qVXlNVEl4TXpkYU1IOHhHVEFYQmdOVkJBVVRFRU5RU2kweUxURXdNQzB3T1Rnek1URXhDekFKQmdOVkJBWVRBa05TTVE4d0RRWURWUVFLRXdaTlNVTkpWRlF4RFRBTEJnTlZCQXNUQkVSRFJrUXhOVEF6QmdOVkJBTVRMRU5CSUZCUFRFbFVTVU5CSUZCRlVsTlBUa0VnU2xWU1NVUkpRMEVnTFNCRFQxTlVRU0JTU1VOQklIWXlNSUlDSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQWc4QU1JSUNDZ0tDQWdFQXc3WnFuRGh6c2RXUlBYYkt6WXBMTXlJRkN4SDh3TURsYlVacDV5RDIvcE1CNllNR0gvOGtqRVc2QTA0KzJiSE4yaVUvMlNMSmJ1NU5KOEFrQ0xzSjl2bDhBR1hGVzB5MlVTVWcxbjV0ajlUbFFKNDlEY0ZGSi9GYjlLYmc2YmFBZXNBTFhqcWJzelpzaWNVanpwZDdwT3RiSG9jejBNazNjSHo2Wll3N3pRckRLQmxDYUtEQmx2Sks1M0oreEl2TUFxZ0Q5Tk1tZnJZN05KcmRrc2xkeTd6QzljOVdhQ1JwbDBrWWVDL3k0QnZicldNZjFNdThFcFpjRjZvUDJPUCt2bENKUWYwdWRBMWNIbEF0a3NaZTh5RU5RRzRCZUxVR0hXeUFrRU85ZTh3RmJ5bEd1a3ZVWlZKcUJ1eHlzR0VmMzBKSDZUd2NKWVp3NEZMb3JRdTZhaW4zVGFwU0ZkV3NZemhSVElEYlVPam03QTRUaUVNL3Zyc1NzZkpFRWhCL3YzNmZuYllqb2dzUFVkb3dZRnE2YWZoMUcrTE8xaHkvNDNVOGxucXdwblZlT1E3MTBuS0swVEpvZ0NLTGduQUpiWnNVU3lFYy9DM2ZuaWJOd3VGblhJbkt1TlRuL1BGL1VrcHFYVkV5U3ZpOWlaS1lyR2JQVmZNOGZUeUVCUFRNVzN4cThMZGF2NGtvbXI5OGpqU25abHB6Vm5RS3FvMVRpNU13TFV6THI2T1hTbVY3RG8zN2dQanlkSkZXWjdUYnZjQVFCaFlnUmhqOVdGY05PK01HOW5Vc1JuNlVoUzdFNG5QWDUxQXQ4RWh1OTVUWitKSDJieklvb2l1WDdUVGxGV25ERmxhSGh6bU4rdmhBZmdwaDZpS3RMVFhTUjhMS05NcXRwTXVqVzlVQ0F3RUFBYU9DQitrd2dnZmxNQkFHQ1NzR0FRUUJnamNWQVFRREFnRUFNQjBHQTFVZERnUVdCQlJYdDRiL2FDY0dHV1ByenZ4U0VaV25JbmdVN1RDQ0JaZ0dBMVVkSUFTQ0JZOHdnZ1dMTUlJQkZBWUhZSUU4QVFFQkFUQ0NBUWN3Z2FZR0NDc0dBUVVGQndJQ01JR1pIb0dXQUVrQWJRQndBR3dBWlFCdEFHVUFiZ0IwQUdFQUlBQnNBR0VBSUFCUUFHOEFiQUJwQUhRQWFRQmpBR0VBSUFCa0FHVUFJQUJzQUdFQUlBQlNBR0VBYVFCNkFDQUFRd0J2QUhNQWRBQmhBSElBY2dCcEFHTUFaUUJ1QUhNQVpRQWdBR1FBWlFBZ0FFTUFaUUJ5QUhRQWFRQm1BR2tBWXdCaEFHTUFhUUJ2QUc0QUlBQkVBR2tBWndCcEFIUUFZUUJzQUNBQWRnQXlNQ29HQ0NzR0FRVUZCd0lCRmg1b2RIUndPaTh2ZDNkM0xtWnBjbTFoWkdsbmFYUmhiQzVuYnk1amNnQXdNQVlJS3dZQkJRVUhBZ0VXSkdoMGRIQTZMeTkzZDNjdWJXbGphWFF1WjI4dVkzSXZabWx5YldGa2FXZHBkR0ZzQURDQ0FWa0dDR0NCUEFFQkFRRUJNSUlCU3pDQjZnWUlLd1lCQlFVSEFnSXdnZDBlZ2RvQVNRQnRBSEFBYkFCbEFHMEFaUUJ1QUhRQVlRQWdBR3dBWVFBZ0FGQUFid0JzQUdrQWRBQnBBR01BWVFBZ0FHUUFaUUFnQUVNQVFRQWdBRVVBYlFCcEFITUFid0J5QUdFQUlBQndBR0VBY2dCaEFDQUFVQUJsQUhJQWN3QnZBRzRBWVFCekFDQUFTZ0IxQUhJQWFRQmtBR2tBWXdCaEFITUFJQUJ3QUdVQWNnQjBBR1VBYmdCbEFHTUFhUUJsQUc0QWRBQmxBQ0FBWVFBZ0FHd0FZUUFnQUZBQVN3QkpBQ0FBVGdCaEFHTUFhUUJ2QUc0QVlRQnNBQ0FBWkFCbEFDQUFRd0J2QUhNQWRBQmhBQ0FBVWdCcEFHTUFZUUFnQUhZQU1qQXFCZ2dyQmdFRkJRY0NBUlllYUhSMGNEb3ZMM2QzZHk1bWFYSnRZV1JwWjJsMFlXd3VaMjh1WTNJQU1EQUdDQ3NHQVFVRkJ3SUJGaVJvZEhSd09pOHZkM2QzTG0xcFkybDBMbWR2TG1OeUwyWnBjbTFoWkdsbmFYUmhiQUF3Z2dHR0JnaGdnVHdCQVFFQkJqQ0NBWGd3Z2dFV0JnZ3JCZ0VGQlFjQ0FqQ0NBUWdlZ2dFRUFFa0FiUUJ3QUd3QVpRQnRBR1VBYmdCMEFHRUFJQUJzQUdFQUlBQlFBRzhBYkFCcEFIUUFhUUJqQUdFQUlBQndBR0VBY2dCaEFDQUFRd0JsQUhJQWRBQnBBR1lBYVFCakFHRUFaQUJ2QUhNQUlBQmtBR1VBSUFCVEFHVUFiQUJzQUc4QUlBQkZBR3dBWlFCakFIUUFjZ0J2QUc0QWFRQmpBRzhBSUFCa0FHVUFJQUJRQUdVQWNnQnpBRzhBYmdCaEFDQUFTZ0IxQUhJQWFRQmtBR2tBWXdCaEFDQUFjQUJsQUhJQWRBQmxBRzRBWlFCakFHa0FaUUJ1QUhRQVpRQWdBR0VBSUFCc0FHRUFJQUJRQUVzQVNRQWdBRTRBWVFCakFHa0Fid0J1QUdFQWJBQWdBR1FBWlFBZ0FFTUFid0J6QUhRQVlRQWdBRklBYVFCakFHRUFJQUIyQURJd0tnWUlLd1lCQlFVSEFnRVdIbWgwZEhBNkx5OTNkM2N1Wm1seWJXRmthV2RwZEdGc0xtZHZMbU55QURBd0JnZ3JCZ0VGQlFjQ0FSWWthSFIwY0RvdkwzZDNkeTV0YVdOcGRDNW5ieTVqY2k5bWFYSnRZV1JwWjJsMFlXd0FNSUlCaUFZSVlJRThBUUVCQVFjd2dnRjZNSUlCR0FZSUt3WUJCUVVIQWdJd2dnRUtIb0lCQmdCSkFHMEFjQUJzQUdVQWJRQmxBRzRBZEFCaEFDQUFiQUJoQUNBQVVBQnZBR3dBYVFCMEFHa0FZd0JoQUNBQWNBQmhBSElBWVFBZ0FFTUFaUUJ5QUhRQWFRQm1BR2tBWXdCaEFHUUFid0J6QUNBQVpBQmxBQ0FBUVFCbkFHVUFiZ0IwQUdVQUlBQkZBR3dBWlFCakFIUUFjZ0J2QUc0QWFRQmpBRzhBSUFCa0FHVUFJQUJRQUdVQWNnQnpBRzhBYmdCaEFDQUFTZ0IxQUhJQWFRQmtBR2tBWXdCaEFDQUFjQUJsQUhJQWRBQmxBRzRBWlFCakFHa0FaUUJ1QUhRQVpRQWdBR0VBSUFCc0FHRUFJQUJRQUVzQVNRQWdBRTRBWVFCakFHa0Fid0J1QUdFQWJBQWdBR1FBWlFBZ0FFTUFid0J6QUhRQVlRQWdBRklBYVFCakFHRUFJQUIyQURJd0tnWUlLd1lCQlFVSEFnRVdIbWgwZEhBNkx5OTNkM2N1Wm1seWJXRmthV2RwZEdGc0xtZHZMbU55QURBd0JnZ3JCZ0VGQlFjQ0FSWWthSFIwY0RvdkwzZDNkeTV0YVdOcGRDNW5ieTVqY2k5bWFYSnRZV1JwWjJsMFlXd0FNQmtHQ1NzR0FRUUJnamNVQWdRTUhnb0FVd0IxQUdJQVF3QkJNQXNHQTFVZER3UUVBd0lCaGpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUI4R0ExVWRJd1FZTUJhQUZPRHkvbjNFUkU1UTVEWDlDSW1QVG9RWlJETkFNSUhTQmdOVkhSOEVnY293Z2Njd2djU2dnY0dnZ2I2R1dtaDBkSEE2THk5M2QzY3VabWx5YldGa2FXZHBkR0ZzTG1kdkxtTnlMM0psY0c5emFYUnZjbWx2TDBOQkpUSXdVa0ZKV2lVeU1FNUJRMGxQVGtGTUpUSXdMU1V5TUVOUFUxUkJKVEl3VWtsRFFTVXlNSFl5TG1OeWJJWmdhSFIwY0RvdkwzZDNkeTV0YVdOcGRDNW5ieTVqY2k5bWFYSnRZV1JwWjJsMFlXd3ZjbVZ3YjNOcGRHOXlhVzh2UTBFbE1qQlNRVWxhSlRJd1RrRkRTVTlPUVV3bE1qQXRKVEl3UTA5VFZFRWxNakJTU1VOQkpUSXdkakl1WTNKc01JSG1CZ2dyQmdFRkJRY0JBUVNCMlRDQjFqQm1CZ2dyQmdFRkJRY3dBb1phYUhSMGNEb3ZMM2QzZHk1bWFYSnRZV1JwWjJsMFlXd3VaMjh1WTNJdmNtVndiM05wZEc5eWFXOHZRMEVsTWpCU1FVbGFKVEl3VGtGRFNVOU9RVXdsTWpBdEpUSXdRMDlUVkVFbE1qQlNTVU5CSlRJd2RqSXVZM0owTUd3R0NDc0dBUVVGQnpBQ2htQm9kSFJ3T2k4dmQzZDNMbTFwWTJsMExtZHZMbU55TDJacGNtMWhaR2xuYVhSaGJDOXlaWEJ2YzJsMGIzSnBieTlEUVNVeU1GSkJTVm9sTWpCT1FVTkpUMDVCVENVeU1DMGxNakJEVDFOVVFTVXlNRkpKUTBFbE1qQjJNaTVqY25Rd0RRWUpLb1pJaHZjTkFRRU5CUUFEZ2dJQkFMNFZzRzR4em9aR2M0ZzhwYzBXTmNrZWdhNlZnNXdxNExWTVpqdUVvUEUzUndrVmYycnQxa1lXT3VzaGl6UDZQRFRPMkZHak9adFdERVI4aVZqaERDRzRRK05VNXBwZVZRY3dudXQxTHg5bUdTVW9mS3NtWVFzSDZ2RXoxSFh4MTdaL09WcHFpR0NKakVscWdCeDZURWRnMU9aRkFQR01KNjVPT0cwNTB1N2pBOW9OZ0srbXYrQ2hqNVdFT2Zkd2srMndyMWR5K2FSTmp1Vlh6Zk9IZWJYNkxNeUd2SFR4QitFVGxOUHBKdDFZRTJucGhzaHRTaVN5Y2lDZUtkci83cHBsS01KaURHUlBHS1A0WlJZMlErS1NDbUFyZ1RoRVNDUVU4OStDNitYOGwvOFJIL1NuRkRSK0NSakxnYXZOM04rVFl4RDg3RldjTFZFTEFJTzZuWXlobmJ1eWhuWnNyNi9oMTFMZWVMNjdHY3NoSk9NcDJTenNsSzFTUVROVzNFZ1VidFdmd2Rxek9ieXVDTVZ5TFRxVU5MRmN5ZkpaMzB5RmFOVFBmWHJWS3JKVS9QdmdrTkxNVG9qOTMwWllqMHJVR1FkTks2aE54eXJrNEpRa0RqRWdKeVpWaE5obmlta2ZJeVhQaU16NUlRK1NwNkVKYlhURWNGY3U0b0l3Um1vY1NOcmNLOHp1QjRpSDlJdzhhc1I3c3dReTdMVnMvRnBIanR0M1pDaE9kVTN6TVNrWlFqajM0NjExUUpHUHl0bHhBWlVFeUovOUU4VGlEcCs0TDFJSmNOQWVZS3UzMmhQY3NBYUp3ZUl3ajE0SUNDWjFjb0d6K2sweEhOVVF6TFFuZm9kQ09MMGgzMHk0RURSK3laaHlYVnlYSEtyNFZ5WktNdVU0endkRzwvZHM6WDUwOUNlcnRpZmljYXRlPjxkczpYNTA5Q2VydGlmaWNhdGU+TUlJTUFUQ0NDZW1nQXdJQkFnSVRjQUFBQUFTMUVBU0hxbCtGd1FBQUFBQUFCREFOQmdrcWhraUc5dzBCQVEwRkFEQi9NUmt3RndZRFZRUUZFeEJEVUVvdE1pMHhNREF0TURrNE16RXhNUXN3Q1FZRFZRUUdFd0pEVWpFUE1BMEdBMVVFQ2hNR1RVbERTVlJVTVEwd0N3WURWUVFMRXdSRVEwWkVNVFV3TXdZRFZRUURFeXhEUVNCUVQweEpWRWxEUVNCUVJWSlRUMDVCSUVwVlVrbEVTVU5CSUMwZ1EwOVRWRUVnVWtsRFFTQjJNakFlRncweE5UQTNNamt4T0RBME5EbGFGdzB5TXpBM01qa3hPREUwTkRsYU1JR2JNUmt3RndZRFZRUUZFeEJEVUVvdE5DMHdNREF0TURBME1ERTNNUXN3Q1FZRFZRUUdFd0pEVWpFa01DSUdBMVVFQ2hNYlFrRk9RMDhnUTBWT1ZGSkJUQ0JFUlNCRFQxTlVRU0JTU1VOQk1TSXdJQVlEVlFRTEV4bEVTVlpKVTBsUFRpQlRTVk5VUlUxQlV5QkVSU0JRUVVkUE1TY3dKUVlEVlFRREV4NURRU0JUU1U1UVJTQXRJRkJGVWxOUFRrRWdTbFZTU1VSSlEwRWdkakl3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRRFMwTzlvMlIyQVV5dFJWWHpMRCtsMXRQVE1hR1NOTDV0VHRYajNPbEFnWWwyRDlUb3VHMm9lU3ZnT3JLd0tVTHJiR0JmaFJtV3ZOci80UFo3aVRxL2wyTjFqWWEya01iUGNoWm91b2hqSWZPYmhYdEo1eUVVWkZPMEw0SEMxdGgrRldlZTA4K3JEblJldTF2R3VoRzQ3U2pmOHByeXFxQk1OaVlsRDFNSWNoRmNIOWRXdkxYc3FCakgwcVpaTXRqcHVVVVRJdnJMSEcwd2Y1RXNhKzRacnBPYnlnRUE4aE1USkpENWd4bVpFRFRtc2kwdm9QL01XUjVtS0RtbTJRTXVJa05wYjdLTWI0TmRiaUFwdHFGdGs4V1NpVEZwOUFMTWkwWnVLa3hPZzg3eksxVUhReTBKbjNLaDh1YmExcy9kOXNKYUZhZmhnRDNTb29QY04yOHNOQWdNQkFBR2pnZ2RYTUlJSFV6QVFCZ2tyQmdFRUFZSTNGUUVFQXdJQkFEQWRCZ05WSFE0RUZnUVVpQ1Q4NjNIU2NjbW9XYklMZjVUY1Q0UmEydEl3Z2dUS0JnTlZIU0FFZ2dUQk1JSUV2VENCNFFZSFlJRThBUUVCQVRDQjFUQ0JwZ1lJS3dZQkJRVUhBZ0l3Z1prZWdaWUFTUUJ0QUhBQWJBQmxBRzBBWlFCdUFIUUFZUUFnQUd3QVlRQWdBRkFBYndCc0FPMEFkQUJwQUdNQVlRQWdBR1FBWlFBZ0FHd0FZUUFnQUZJQVlRRHRBSG9BSUFCREFHOEFjd0IwQUdFQWNnQnlBR2tBWXdCbEFHNEFjd0JsQUNBQVpBQmxBQ0FBUXdCbEFISUFkQUJwQUdZQWFRQmpBR0VBWXdCcEFQTUFiZ0FnQUVRQWFRQm5BR2tBZEFCaEFHd0FJQUIyQURJd0tnWUlLd1lCQlFVSEFnRVdIbWgwZEhBNkx5OTNkM2N1Wm1seWJXRmthV2RwZEdGc0xtZHZMbU55QURDQ0FTTUdDR0NCUEFFQkFRRUJNSUlCRlRDQjVnWUlLd1lCQlFVSEFnSXdnZGtlZ2RZQVNRQnRBSEFBYkFCbEFHMEFaUUJ1QUhRQVlRQWdBR3dBWVFBZ0FGQUFid0JzQU8wQWRBQnBBR01BWVFBZ0FHUUFaUUFnQUVNQVFRQWdBRVVBYlFCcEFITUFid0J5QUdFQUlBQndBR0VBY2dCaEFDQUFVQUJsQUhJQWN3QnZBRzRBWVFBZ0FFb0FkUUJ5QU8wQVpBQnBBR01BWVFBZ0FIQUFaUUJ5QUhRQVpRQnVBR1VBWXdCcEFHVUFiZ0IwQUdVQUlBQmhBQ0FBYkFCaEFDQUFVQUJMQUVrQUlBQk9BR0VBWXdCcEFHOEFiZ0JoQUd3QUlBQmtBR1VBSUFCREFHOEFjd0IwQUdFQUlBQlNBR2tBWXdCaEFDQUFkZ0F5TUNvR0NDc0dBUVVGQndJQkZoNW9kSFJ3T2k4dmQzZDNMbVpwY20xaFpHbG5hWFJoYkM1bmJ5NWpjZ0F3Z2dGVUJnaGdnVHdCQVFFQkJqQ0NBVVl3Z2dFV0JnZ3JCZ0VGQlFjQ0FqQ0NBUWdlZ2dFRUFFa0FiUUJ3QUd3QVpRQnRBR1VBYmdCMEFHRUFJQUJzQUdFQUlBQlFBRzhBYkFEdEFIUUFhUUJqQUdFQUlBQndBR0VBY2dCaEFDQUFRd0JsQUhJQWRBQnBBR1lBYVFCakFHRUFaQUJ2QUhNQUlBQmtBR1VBSUFCVEFHVUFiQUJzQUc4QUlBQkZBR3dBWlFCakFIUUFjZ0R6QUc0QWFRQmpBRzhBSUFCa0FHVUFJQUJRQUdVQWNnQnpBRzhBYmdCaEFDQUFTZ0IxQUhJQTdRQmtBR2tBWXdCaEFDQUFjQUJsQUhJQWRBQmxBRzRBWlFCakFHa0FaUUJ1QUhRQVpRQWdBR0VBSUFCc0FHRUFJQUJRQUVzQVNRQWdBRTRBWVFCakFHa0Fid0J1QUdFQWJBQWdBR1FBWlFBZ0FFTUFid0J6QUhRQVlRQWdBRklBYVFCakFHRUFJQUIyQURJd0tnWUlLd1lCQlFVSEFnRVdIbWgwZEhBNkx5OTNkM2N1Wm1seWJXRmthV2RwZEdGc0xtZHZMbU55QURDQ0FWWUdDR0NCUEFFQkFRRUhNSUlCU0RDQ0FSZ0dDQ3NHQVFVRkJ3SUNNSUlCQ2g2Q0FRWUFTUUJ0QUhBQWJBQmxBRzBBWlFCdUFIUUFZUUFnQUd3QVlRQWdBRkFBYndCc0FPMEFkQUJwQUdNQVlRQWdBSEFBWVFCeUFHRUFJQUJEQUdVQWNnQjBBR2tBWmdCcEFHTUFZUUJrQUc4QWN3QWdBR1FBWlFBZ0FFRUFad0JsQUc0QWRBQmxBQ0FBUlFCc0FHVUFZd0IwQUhJQTh3QnVBR2tBWXdCdkFDQUFaQUJsQUNBQVVBQmxBSElBY3dCdkFHNEFZUUFnQUVvQWRRQnlBTzBBWkFCcEFHTUFZUUFnQUhBQVpRQnlBSFFBWlFCdUFHVUFZd0JwQUdVQWJnQjBBR1VBSUFCaEFDQUFiQUJoQUNBQVVBQkxBRWtBSUFCT0FHRUFZd0JwQUc4QWJnQmhBR3dBSUFCa0FHVUFJQUJEQUc4QWN3QjBBR0VBSUFCU0FHa0FZd0JoQUNBQWRnQXlNQ29HQ0NzR0FRVUZCd0lCRmg1b2RIUndPaTh2ZDNkM0xtWnBjbTFoWkdsbmFYUmhiQzVuYnk1amNnQXdHUVlKS3dZQkJBR0NOeFFDQkF3ZUNnQlRBSFVBWWdCREFFRXdDd1lEVlIwUEJBUURBZ0dHTUJJR0ExVWRFd0VCL3dRSU1BWUJBZjhDQVFBd0h3WURWUjBqQkJnd0ZvQVVWN2VHLzJnbkJobGo2ODc4VWhHVnB5SjRGTzB3Z2U0R0ExVWRId1NCNWpDQjR6Q0I0S0NCM2FDQjJvWm9hSFIwY0RvdkwzZDNkeTVtYVhKdFlXUnBaMmwwWVd3dVoyOHVZM0l2Y21Wd2IzTnBkRzl5YVc4dlEwRWxNakJRVDB4SlZFbERRU1V5TUZCRlVsTlBUa0VsTWpCS1ZWSkpSRWxEUVNVeU1DMGxNakJEVDFOVVFTVXlNRkpKUTBFbE1qQjJNaTVqY215R2JtaDBkSEE2THk5M2QzY3ViV2xqYVhRdVoyOHVZM0l2Wm1seWJXRmthV2RwZEdGc0wzSmxjRzl6YVhSdmNtbHZMME5CSlRJd1VFOU1TVlJKUTBFbE1qQlFSVkpUVDA1QkpUSXdTbFZTU1VSSlEwRWxNakF0SlRJd1EwOVRWRUVsTWpCU1NVTkJKVEl3ZGpJdVkzSnNNSUlCQWdZSUt3WUJCUVVIQVFFRWdmVXdnZkl3ZEFZSUt3WUJCUVVITUFLR2FHaDBkSEE2THk5M2QzY3VabWx5YldGa2FXZHBkR0ZzTG1kdkxtTnlMM0psY0c5emFYUnZjbWx2TDBOQkpUSXdVRTlNU1ZSSlEwRWxNakJRUlZKVFQwNUJKVEl3U2xWU1NVUkpRMEVsTWpBdEpUSXdRMDlUVkVFbE1qQlNTVU5CSlRJd2RqSXVZM0owTUhvR0NDc0dBUVVGQnpBQ2htNW9kSFJ3T2k4dmQzZDNMbTFwWTJsMExtZHZMbU55TDJacGNtMWhaR2xuYVhSaGJDOXlaWEJ2YzJsMGIzSnBieTlEUVNVeU1GQlBURWxVU1VOQkpUSXdVRVZTVTA5T1FTVXlNRXBWVWtsRVNVTkJKVEl3TFNVeU1FTlBVMVJCSlRJd1VrbERRU1V5TUhZeUxtTnlkREFOQmdrcWhraUc5dzBCQVEwRkFBT0NBZ0VBanl6bXo0SGt3UHYzWnNwZ3NqQUM3b1JhandTakpqTmdCWit1Tm9LTldDalVzQWEvRTlISHcrSFk0NjhkUlhTc0RScEVNNzE3ZVQ3YW44V0p1cXRPckcrSkxjR3lYS0xremRaVmNjbDlJMHFNWFhXeHlLRWNCOVVkVzdNK21jUE5idlhBajNsUWNQV3dIVDNIdktFZkFzOGJlNGhxeXlLVUFueTJ2SkJYRmdBdXNXWUljeWRUc3Y3WTBFS2lwSy9OTUtBTFI3RERMTXpKRmMrYlFDOEhZdHp4OTZTbWdHbFdYMXpHMzZBaWQ5cEZ1NnovTWw2TVZ4NE9Xd3I5RHZyRHVBaU8rN1JHWXN6UmlKK0dicGJkQkR2eWJmUHd2NGZzMzVQQllWcFF0K1Q5ZTkrYUFkZVJNQjZ0M1BjcjIyME1GNEI5MTFKQjZOUlk3anN5UXBpY1hDM3pzTjhMWklGd0pEa1JpVGVRNGV3TitiMDRKc09wbU51ZlNLbWdmdS9EMUg1eDJDMmQzMEN0OWNmanUxMkU4aVBZK1hNVDZpcUZXazlUSFFuWEJXRjJHSmRjaTg1S1cxUWtTRm9zVE94d2RlRlRkbXJuMHhERlZESUowZVFmVENtalk1dVQyWHZhOTlmNVIwQ1lhd3BXeUZHejlEcWptcHZlNjBzTFNIRWswOHFvMW1uZjhPT1ZMT0lqS3JnS05Sc0NIYldDODVGZlordjN2aDRTSURFSTROaVdwbE9Gbkk3R25nRkc4QStBOEFmRDV0N3Q4aTQ3eVd2bk5jT2xIZE5hU0praGFuR09yaG5Kc1JlY0toNldVM3FzbzFIUlhuNW82TThoZWMxMjNIUU5WVlcwelh4SStOdFk5dktxRGtHcE5na1BiQ1hnUVhKTTVaQjUvZDg9PC9kczpYNTA5Q2VydGlmaWNhdGU+PC9kczpYNTA5RGF0YT48L2RzOktleUluZm8+PGRzOk9iamVjdD48eGFkZXM6UXVhbGlmeWluZ1Byb3BlcnRpZXMgeG1sbnM6eGFkZXM9Imh0dHA6Ly91cmkuZXRzaS5vcmcvMDE5MDMvdjEuMy4yIyIgVGFyZ2V0PSIjaWQtYWRiYjAwNDRmNTY4ZjA3ZWRkMzQ5Mjk1MjhkNjY4M2MiPjx4YWRlczpTaWduZWRQcm9wZXJ0aWVzIElkPSJ4YWRlcy1pZC1hZGJiMDA0NGY1NjhmMDdlZGQzNDkyOTUyOGQ2NjgzYyI+PHhhZGVzOlNpZ25lZFNpZ25hdHVyZVByb3BlcnRpZXM+PHhhZGVzOlNpZ25pbmdUaW1lPjIwMTgtMDktMDJUMTU6MDU6NDFaPC94YWRlczpTaWduaW5nVGltZT48eGFkZXM6U2lnbmluZ0NlcnRpZmljYXRlPjx4YWRlczpDZXJ0Pjx4YWRlczpDZXJ0RGlnZXN0PjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIvPjxkczpEaWdlc3RWYWx1ZT4yYjJCTHNLT3dqMmdkQXVkQm9WZUE2RVlKeGc9PC9kczpEaWdlc3RWYWx1ZT48L3hhZGVzOkNlcnREaWdlc3Q+PHhhZGVzOklzc3VlclNlcmlhbD48ZHM6WDUwOUlzc3Vlck5hbWU+Q049Q0EgU0lOUEUgLSBQRVJTT05BIEpVUklESUNBIHYyLE9VPURJVklTSU9OIFNJU1RFTUFTIERFIFBBR08sTz1CQU5DTyBDRU5UUkFMIERFIENPU1RBIFJJQ0EsQz1DUiwyLjUuNC41PSMxMzEwNDM1MDRhMmQzNDJkMzAzMDMwMmQzMDMwMzQzMDMxMzc8L2RzOlg1MDlJc3N1ZXJOYW1lPjxkczpYNTA5U2VyaWFsTnVtYmVyPjE2MDU2NTM2NTQ5NjMzOTAyMjQwMjgzMTYxMjM5Mjk5MTc3ODE3MTUxODk4ODg8L2RzOlg1MDlTZXJpYWxOdW1iZXI+PC94YWRlczpJc3N1ZXJTZXJpYWw+PC94YWRlczpDZXJ0PjwveGFkZXM6U2lnbmluZ0NlcnRpZmljYXRlPjwveGFkZXM6U2lnbmVkU2lnbmF0dXJlUHJvcGVydGllcz48eGFkZXM6U2lnbmVkRGF0YU9iamVjdFByb3BlcnRpZXM+PHhhZGVzOkRhdGFPYmplY3RGb3JtYXQgT2JqZWN0UmVmZXJlbmNlPSIjci1pZC0xIj48eGFkZXM6TWltZVR5cGU+YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtPC94YWRlczpNaW1lVHlwZT48L3hhZGVzOkRhdGFPYmplY3RGb3JtYXQ+PC94YWRlczpTaWduZWREYXRhT2JqZWN0UHJvcGVydGllcz48L3hhZGVzOlNpZ25lZFByb3BlcnRpZXM+PC94YWRlczpRdWFsaWZ5aW5nUHJvcGVydGllcz48L2RzOk9iamVjdD48L2RzOlNpZ25hdHVyZT48L01lbnNhamVIYWNpZW5kYT4="
            Dim xmlFromBase64 As Byte()
            xmlFromBase64 = Convert.FromBase64String(base64)

            Dim xml As String = System.Text.Encoding.UTF8.GetString(xmlFromBase64, 0, xmlFromBase64.Length)

            Dim fPathTMP = "D:\EasyATV\XML_Te\" & "MensajeRechazo_" & "TMP" & ".xml"
            Dim afileTMP As New IO.StreamWriter(fPathTMP, False)
            afileTMP.WriteLine(xml)
            afileTMP.Close()

            Dim xmlTMP As Xml.XmlDocument = New Xml.XmlDocument()
            xmlTMP.Load(fPathTMP)

            Dim DetalleMensaje As String = xmlTMP.GetElementsByTagName("DetalleMensaje").Item(0).InnerText

            strSQL = "UPDATE GB_Control_FE SET Detalle_Mensaje_Rechazo = '" & DetalleMensaje.Replace("'", "") & "' WHERE Clave_Unica_FE = '" & ds.Tables("Tabla").Rows(i)("Clave_Unica_FE").ToString & "'"
            funRunSQL(strSQL)

        Next

        MsgBox("Proceso ha finalizado!", MsgBoxStyle.Information)

    End Sub

    'Este timer corre cada 60 segundos.
    'La secuencia primero Muestra los tiquetes que no han sido enviados en el DataGrid.
    'Después muestra los tiquetes que va a enviar en el DataGrid2.
    'Después envia los tíquetes al Ministerio de Hacienda. 
    'El timer corre cada 60 segundos y si el tiquete falla queda en estado pendiente.
    'El timer2 que se encuentra en el mismo Form1.vb corre cada 60 minutos y toma los  
    'tíquetes que han quedado pendientes de transmitir por el proceso que se hace en el 
    'timer1. 
    'Fecha       :    18 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Timer.
    'Nombre      :    Timer1.
    'Base        :    LDCOM_MUNDOMAGICO

    Private Sub Timer1_Tick(sender As Object, e As EventArgs) Handles Timer1.Tick
        MostrarTiquetes()            'Mostrar en Datagrid1 tiquetes que se envían por primera vez.
        MostrarTiquetesEnviado()     'Mostrar en DataGrid2 tiquetes que estaban pendientes porque habían fallado.  
        EnviarTiquetes()             'Transmitir Tiquetes.
    End Sub


    'El timer2 que se encuentra en el mismo Form1.vb corre cada 60 minutos y toma los  
    'tíquetes que han quedado pendientes de transmitir por algún error por el proceso que se hace en el 
    'timer1. 
    'Fecha       :    21 de Noviembre del 2018.
    'Autor       :    Jorge López Jiménez.
    'Tipo Doc    :    Primera Documentación.
    'Ubicación   :    Form1.vb.
    'Tipo Objeto :    Timer.
    'Nombre      :    Timer2.
    'Base        :    LDCOM_MUNDOMAGICO
    'Tablas      :    vw_FE_Control, GB_Control_FE

    Private Sub Timer2_Tick(sender As Object, e As EventArgs) Handles Timer2.Tick
        EstadoRecepcion()
    End Sub


    'Llama el procedimiento de TiquetesRechazados
    'para actualizar la base de datos con 
    'las razones de rechazo de Hacienda
    'de los archivos hcia la base de datos.
    'Fecha         :    21 de Noviembre del 2018.
    'Autor         :    Jorge López Jiménez.
    'Tipo Doc      :    Primera Documentación.
    'Ubicación     :    Botón btnMensajeRechazados en forma Form1.vb.
    'Tipo Objeto   :    Botón.
    'Nombre        :    btnMensajeRechazados.
    'Procedimiento :    Click en btnMensajeRechazados.
    'Base          :    LDCOM_MUNDOMAGICO.
    'Tablas        :    Ninguno.

    Private Sub btnMensajeRechazados_Click(sender As Object, e As EventArgs) Handles btnMensajeRechazados.Click
        TiquetesRechazados()
    End Sub

    'Se sale del form pero le advierte al cliente que se pueden 
    'perder datos ya que puede estar procesando datos hacia Hacienda.
    'El usuario escoge si se sale puede dejar datos no transmitidos 
    'o en un estado corrupto.
    'Fecha         :    21 de Noviembre del 2018.
    'Autor         :    Jorge López Jiménez.
    'Tipo Doc      :    Primera Documentación.
    'Ubicación     :    Form1.vb.
    'Tipo Objeto   :    Forma.
    'Nombre        :    Form1.
    'Procedimiento :    Salir del Form.
    'Base          :    LDCOM_MUNDOMAGICO.
    'Tablas        :    Ninguno.

    Private Sub frmMain_FormClosing(ByVal sender As Object, ByVal e As System.Windows.Forms.FormClosingEventArgs) Handles Me.FormClosing
        If MsgBox("¿Desea cerrar la aplicación? " & vbCr _
                  & "Advertencia: al cerrar la aplicación se detiene el proceso y es posible que se pierdan datos!", MsgBoxStyle.YesNo + MsgBoxStyle.Question, "Cerrar la aplicación") = MsgBoxResult.No Then
            e.Cancel = True
        End If
    End Sub


    'Hace los mismo que el timer2 cada hora
    'corre el procedimiento EstadoRecepcion() que intenta
    'transmitir los tíquetes que no se habían podido transmitir
    'la primera vez.
    'Fecha         :    26 de Noviembre del 2018.
    'Autor         :    Jorge López Jiménez.
    'Tipo Doc      :    Primera Documentación.
    'Ubicación     :    Form1.vb.
    'Tipo Objeto   :    Botón.
    'Nombre        :    btnVerificarEstado.
    'Procedimiento :    Corre el procedimiento EstadoRecepcion().
    'Base          :    LDCOM_MUNDOMAGICO.
    'Tablas        :    Ninguno.
    Private Sub btnVerificarEstado_Click(sender As Object, e As EventArgs) Handles btnVerificarEstado.Click
        lblVerificarEstado.Text = "Verificando..."
        MsgBox("Verificando...", MsgBoxStyle.Information)
        EstadoRecepcion()
        lblVerificarEstado.Text = "..."
    End Sub


End Class
